<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>电子产品成本计算器</title>
    <!-- Tailwind CSS v3 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <!-- Day.js -->
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <!-- React -->
    <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.development.js"></script>
    <!-- React DOM -->
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.development.js"></script>
    <!-- Babel (用于JSX转换) -->
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.23.4/babel.min.js"></script>
      <!-- 统一的 Tailwind 配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6', // 科技蓝
                        secondary: '#6B7280', // 中性灰
                        accent: '#F97316', // 橙色强调色
                        light: '#F3F4F6',
                        dark: '#1F2937',
                        success: '#10B981', // 成功绿
                        danger: '#EF4444', // 危险红
                        warning: '#F59E0B', // 警告黄
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-in-out',
                        'slide-in': 'slideIn 0.5s ease-in-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                        'slide-down': 'slideDown 0.3s ease-in',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideIn: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(100%)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        slideDown: {
                            '0%': { transform: 'translateY(0)', opacity: '1' },
                            '100%': { transform: 'translateY(100%)', opacity: '0' },
                        }
                    }
                }
            }
        }
    </script>

</head>
<body class="bg-gray-50 min-h-screen">
    <div id="root"></div>

    <!-- 内联产品数据 -->
    <script id="products-data" type="application/json">
        [
            {
                "id": "1",
                "name": "Macbook Air",
                "purchaseDate": "2025-06-23",
                "purchasePrice": 8299,
                "status": "active"
            },
            {
                "id": "2",
                "name": "一加手机",
                "purchaseDate": "2025-01-02",
                "purchasePrice": 3199,
                "status": "active"
            },
            {
                "id": "3",
                "name": "一加平板",
                "purchaseDate": "2025-01-11",
                "purchasePrice": 2230,
                "status": "active"
            },
             {
                "id": "4",
                "name": "OPPO耳机",
                "purchaseDate": "2025-02-19",
                "purchasePrice": 167,
                "status": "active"
            },
             {
                "id": "5",
                "name": "Thinkpad",
                "purchaseDate": "2023-12-03",
                "purchasePrice": 2988,
                "status": "active"
            },
             {
                "id": "6",
                "name": "Macbook Pro",
                "purchaseDate": "2023-07-22",
                "purchasePrice": 6960,
                "status": "active"
            },
             {
                "id": "7",
                "name": "iPhone 15",
                "purchaseDate": "2024-05-20",
                "purchasePrice": 5000,
                "status": "active"
            },
             {
                "id": "8",
                "name": "小米手环",
                "purchaseDate": "2025-06-17",
                "purchasePrice": 309,
                "status": "active"
            },
             {
                "id": "9",
                "name": "OPPO手环",
                "purchaseDate": "2022-07-08",
                "purchasePrice": 240,
                "status": "active"
            },
             {
                "id": "10",
                "name": "OPPO电子秤",
                "purchaseDate": "2022-11-02",
                "purchasePrice": 110,
                "status": "active"
            },
            {
                "id": "11",
                "name": "Macbook Pro i5",
                "purchaseDate": "2016-10-24",
                "purchasePrice": 8092,
                "status": "retired",
                "retirementDate": "2023-07-20"
            }
        ]
    </script>

    <script type="text/babel" data-presets="react">
        // 根据已使用天数计算日均成本，考虑产品状态
        const calculateDailyCost = (product, currentDate = dayjs().format('YYYY-MM-DD')) => {
            // 如果产品已退役，使用退役日期作为计算终点
            const endDate = product.status === 'retired' && product.retirementDate ?
                            product.retirementDate : currentDate;

            // 计算已使用天数
            const daysUsed = calculateDaysBetween(product.purchaseDate, endDate);

            // 如果使用天数为0，返回0（避免除以零）
            return daysUsed > 0 ? product.purchasePrice / daysUsed : 0;
        };

        const calculateDaysBetween = (startDate, endDate) => {
            return Math.abs(dayjs(endDate).diff(dayjs(startDate), 'day'));
        };

        const formatDate = (dateStr, format = 'full') => {
            const d = dayjs(dateStr);
            return format === 'short' ? d.format('MM-DD') : d.format('YYYY-MM-DD');
        };

        const generateId = () => {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        };

        // 生成单个产品的趋势数据
        const generateProductTrendData = (product) => {
            const labels = [];
            const costData = [];
            const start = dayjs(product.purchaseDate);
            const end = product.status === 'retired' && product.retirementDate ? dayjs(product.retirementDate) : dayjs();
            const maxDays = 180;
            let daysGenerated = 0;
            let d = start;
            while (d.isBefore(end.add(1, 'day')) && daysGenerated < maxDays) {
                const dateStr = d.format('YYYY-MM-DD');
                labels.push(d.format('MM-DD'));
                const daysUsed = calculateDaysBetween(product.purchaseDate, dateStr);
                const dailyCost = daysUsed > 0 ? product.purchasePrice / daysUsed : 0;
                costData.push(dailyCost);
                d = d.add(1, 'day');
                daysGenerated++;
            }
            return { labels, costData };
        };

        // 组件
        const Header = () => {
            return (
                <header className="bg-white shadow-sm">
                    <div className="container mx-auto px-4 py-4 flex justify-between items-center">
                        <div className="flex items-center space-x-2">
                            <i className="fa fa-calculator text-primary text-2xl"></i>
                            <h1 className="text-xl font-semibold text-gray-800">电子产品成本计算器</h1>
                        </div>
                    </div>
                </header>
            );
        };

        // 通知提示组件
        const Notification = ({ isOpen, message, type = 'success' }) => {
            if (!isOpen) return null;

            const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';

            return (
                <div className={`fixed top-4 right-4 ${bgColor} text-white px-4 py-2 rounded-md shadow-lg animate-fade-in z-50 flex items-center`}>
                    <i className={`fa ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} mr-2`}></i>
                    {message}
                </div>
            );
        };

        const Summary = ({ products }) => {
            const totalProducts = products.length;

            // 计算今日总成本（只包括服役中产品）
            const todayTotalCost = products.reduce((sum, product) => {
                if (product.status === 'active') {
                    const dailyCost = calculateDailyCost(product);
                    return sum + dailyCost;
                }
                return sum;
            }, 0);

            // 计算总投资金额
            const totalInvestment = products.reduce((sum, product) => {
                return sum + product.purchasePrice;
            }, 0);

            return (
                <section className="mb-8 animate-fade-in">
                    <div className="bg-white rounded-lg shadow-sm p-6 border-l-4 border-primary">
                        <h2 className="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                            <i className="fa fa-calendar-check-o mr-2 text-primary"></i>今日汇总
                        </h2>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div className="bg-blue-50 p-4 rounded-md transform transition-all hover:scale-105">
                                <p className="text-sm text-gray-500">总产品数</p>
                                <p className="text-2xl font-bold text-primary">{totalProducts}</p>
                            </div>
                            <div className="bg-green-50 p-4 rounded-md transform transition-all hover:scale-105">
                                <p className="text-sm text-gray-500">今日总成本</p>
                                <p className="text-2xl font-bold text-green-600">¥{todayTotalCost.toFixed(2)}</p>
                            </div>
                            <div className="bg-purple-50 p-4 rounded-md transform transition-all hover:scale-105">
                                <p className="text-sm text-gray-500">总投资金额</p>
                                <p className="text-2xl font-bold text-purple-600">¥{totalInvestment.toFixed(2)}</p>
                            </div>
                        </div>
                    </div>
                </section>
            );
        };

        const CostTrendChart = ({ days, products }) => {
            const chartRef = React.useRef(null);

            React.useEffect(() => {
                // 生成日期标签和数据
                const { labels, datasets } = generateChartData(days, products);

                // 如果图表已存在，销毁它
                if (chartRef.current) {
                    chartRef.current.destroy();
                }

                // 创建图表
                const ctx = document.getElementById('cost-trend-chart').getContext('2d');
                chartRef.current = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            label += `¥${context.parsed.y.toFixed(2)}`;
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    display: false
                                }
                            },
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return `¥${value.toFixed(2)}`;
                                    }
                                }
                            }
                        },
                        interaction: {
                            mode: 'nearest',
                            axis: 'x',
                            intersect: false
                        },
                        elements: {
                            line: {
                                tension: 0.3
                            }
                        }
                    }
                });

                return () => {
                    if (chartRef.current) {
                        chartRef.current.destroy();
                    }
                };
            }, [days, products]);

            const generateChartData = (days, products) => {
                const labels = [];
                const totalCostData = [];
                const productCosts = {};

                // 初始化产品成本数据
                products.forEach(product => {
                    productCosts[product.id] = {
                        name: product.name,
                        data: []
                    };
                });

                // 生成过去N天的数据
                for (let i = days - 1; i >= 0; i--) {
                    const d = dayjs().subtract(i, 'day');
                    const dateStr = d.format('YYYY-MM-DD');
                    labels.push(d.format('MM-DD'));
                    let dailyTotal = 0;
                    products.forEach(product => {
                        if (dateStr >= product.purchaseDate && product.status === 'active') {
                            const dailyCost = calculateDailyCost(product, dateStr);
                            dailyTotal += dailyCost;
                            productCosts[product.id].data.push(dailyCost);
                        } else {
                            productCosts[product.id].data.push(0);
                        }
                    });
                    totalCostData.push(dailyTotal);
                }

                // 准备数据集
                const datasets = [
                    {
                        label: '总成本',
                        data: totalCostData,
                        borderColor: '#3B82F6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        borderWidth: 2,
                        pointBackgroundColor: '#3B82F6',
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }
                ];

                // 为每个产品添加数据集（最多显示5个产品，避免图表过于复杂）
                const productIds = Object.keys(productCosts).slice(0, 5);
                const colors = ['#F97316', '#10B981', '#8B5CF6', '#EC4899', '#EF4444'];

                productIds.forEach((productId, index) => {
                    const product = productCosts[productId];
                    datasets.push({
                        label: product.name,
                        data: product.data,
                        borderColor: colors[index % colors.length],
                        borderWidth: 2,
                        borderDash: [5, 5],
                        pointBackgroundColor: colors[index % colors.length],
                        pointRadius: 3,
                        pointHoverRadius: 5,
                        fill: false
                    });
                });

                return { labels, datasets };
            };

            return (
                <section className="mb-8 animate-fade-in" style={{ animationDelay: '0.1s' }}>
                    <div className="bg-white rounded-lg shadow-sm p-6">
                        <h2 className="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                            <i className="fa fa-line-chart mr-2 text-primary"></i>成本趋势
                        </h2>
                        <div className="mb-4 flex flex-wrap gap-2">
                            <button
                                className={`time-filter-btn px-3 py-1 rounded-md text-sm ${days === 7 ? 'bg-primary text-white' : 'bg-gray-200 text-gray-700'}`}
                                data-days="7"
                                onClick={() => document.querySelector('[data-days="7"]').click()}
                            >
                                最近7天
                            </button>
                            <button
                                className={`time-filter-btn px-3 py-1 rounded-md text-sm ${days === 30 ? 'bg-primary text-white' : 'bg-gray-200 text-gray-700'}`}
                                data-days="30"
                                onClick={() => document.querySelector('[data-days="30"]').click()}
                            >
                                最近30天
                            </button>
                            <button
                                className={`time-filter-btn px-3 py-1 rounded-md text-sm ${days === 90 ? 'bg-primary text-white' : 'bg-gray-200 text-gray-700'}`}
                                data-days="90"
                                onClick={() => document.querySelector('[data-days="90"]').click()}
                            >
                                最近90天
                            </button>
                        </div>
                        <div className="h-64">
                            <canvas id="cost-trend-chart"></canvas>
                        </div>
                    </div>
                </section>
            );
        };

        // 状态标签组件
        const StatusBadge = ({ status }) => {
            if (status === 'active') {
                return (
                    <span className="px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded-full flex items-center">
                        <span className="w-2 h-2 bg-green-500 rounded-full mr-1"></span>
                        服役中
                    </span>
                );
            } else if (status === 'retired') {
                return (
                    <span className="px-2 py-1 text-xs font-medium bg-gray-100 text-gray-800 rounded-full flex items-center">
                        <span className="w-2 h-2 bg-gray-500 rounded-full mr-1"></span>
                        已退役
                    </span>
                );
            }
            return null;
        };

        // 产品趋势模态框
        const ProductTrendModal = ({ isOpen, onClose, product }) => {
            const chartRef = React.useRef(null);

            React.useEffect(() => {
                if (isOpen && product) {
                    renderChart();
                }

                return () => {
                    if (chartRef.current) {
                        chartRef.current.destroy();
                    }
                };
            }, [isOpen, product]);

            const renderChart = () => {
                const { labels, costData } = generateProductTrendData(product);

                if (chartRef.current) {
                    chartRef.current.destroy();
                }

                const ctx = document.getElementById('product-trend-chart').getContext('2d');
                chartRef.current = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: `${product.name} 日均成本`,
                            data: costData,
                            borderColor: '#3B82F6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            fill: true,
                            borderWidth: 2,
                            pointBackgroundColor: '#3B82F6',
                            pointRadius: 3,
                            pointHoverRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            label += `¥${context.parsed.y.toFixed(2)}`;
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    display: false
                                }
                            },
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return `¥${value.toFixed(2)}`;
                                    }
                                }
                            }
                        },
                        interaction: {
                            mode: 'nearest',
                            axis: 'x',
                            intersect: false
                        },
                        elements: {
                            line: {
                                tension: 0.3
                            }
                        }
                    }
                });
            };

            if (!isOpen || !product) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-4xl mx-4 animate-slide-in">
                        <div className="p-6 border-b flex justify-between items-center">
                            <h3 className="text-lg font-semibold text-gray-800 flex items-center">
                                <i className="fa fa-line-chart mr-2 text-primary"></i>
                                {product.name} 成本趋势
                            </h3>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600 transition-all">
                                <i className="fa fa-times"></i>
                            </button>
                        </div>
                        <div className="p-6">
                            <div className="mb-4 bg-gray-50 p-4 rounded-md">
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <p className="text-sm text-gray-500">购买日期</p>
                                        <p className="font-medium">{formatDate(product.purchaseDate)}</p>
                                    </div>
                                    <div>
                                        <p className="text-sm text-gray-500">购买价格</p>
                                        <p className="font-medium">¥{product.purchasePrice.toFixed(2)}</p>
                                    </div>
                                    <div>
                                        <p className="text-sm text-gray-500">状态</p>
                                        <div className="flex items-center mt-1">
                                            <StatusBadge status={product.status} />
                                            {product.status === 'retired' && product.retirementDate && (
                                                <span className="text-sm text-gray-500 ml-2">
                                                    (退役于 {formatDate(product.retirementDate)})
                                                </span>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div className="h-80">
                                <canvas id="product-trend-chart"></canvas>
                            </div>
                            <div className="mt-4 text-center text-sm text-gray-500">
                                显示从购买日期到{product.status === 'retired' ? '退役日期' : '今天'}的成本趋势（最多显示180天）
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const ProductList = ({ products, onEditProduct, onDeleteProduct, onViewTrend }) => {
            if (products.length === 0) {
                return (
                    <section className="animate-fade-in" style={{ animationDelay: '0.2s' }}>
                        <div className="bg-white rounded-lg shadow-sm overflow-hidden">
                            <div className="p-6 border-b">
                                <h2 className="text-lg font-semibold text-gray-800 flex items-center">
                                    <i className="fa fa-list-ul mr-2 text-primary"></i>产品列表
                                </h2>
                            </div>
                            <div className="p-10 text-center">
                                <div className="flex flex-col items-center">
                                    <div className="w-16 h-16 rounded-full bg-blue-100 flex items-center justify-center mb-4">
                                        <i className="fa fa-info-circle text-primary text-2xl"></i>
                                    </div>
                                    <p className="text-gray-500">暂无产品数据，请添加产品</p>
                                </div>
                            </div>
                        </div>
                    </section>
                );
            }

            return (
                <section className="animate-fade-in" style={{ animationDelay: '0.2s' }}>
                    <div className="bg-white rounded-lg shadow-sm overflow-hidden">
                        <div className="p-6 border-b flex justify-between items-center">
                            <h2 className="text-lg font-semibold text-gray-800 flex items-center">
                                <i className="fa fa-list-ul mr-2 text-primary"></i>产品列表
                            </h2>
                            <div className="text-sm text-gray-500">
                                共 {products.length} 个产品
                            </div>
                        </div>
                        <div className="overflow-x-auto">
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            产品名称
                                        </th>
                                        <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            购买日期
                                        </th>
                                        <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            购买价格
                                        </th>
                                        <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            状态
                                        </th>
                                        <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            已使用天数
                                        </th>
                                        <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            日均成本
                                        </th>
                                         <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            今日成本
                                        </th>
                                        <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            操作
                                        </th>
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                    {products.map(product => {
                                        const {
                                            id,
                                            name,
                                            purchaseDate,
                                            purchasePrice,
                                            status,
                                            retirementDate
                                        } = product;

                                        // 计算已使用天数
                                        const endDate = status === 'retired' && retirementDate ?
                                                        retirementDate : dayjs().format('YYYY-MM-DD');
                                        const daysUsed = calculateDaysBetween(purchaseDate, endDate);

                                        // 计算日均成本
                                        const dailyCost = calculateDailyCost(product);

                                        // 计算今日成本（只对服役中产品计算）
                                        const todayCost = status === 'active' ? dailyCost : 0;

                                        return (
                                            <tr key={id} className="hover:bg-gray-50 transition-all">
                                                <td className="px-6 py-4 whitespace-nowrap">
                                                    <div className="flex items-center">
                                                        <div className="ml-4">
                                                            <div className="text-sm font-medium text-gray-900">{name}</div>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap">
                                                    <div className="text-sm text-gray-900">{formatDate(purchaseDate)}</div>
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap">
                                                    <div className="text-sm text-gray-900">¥{purchasePrice.toFixed(2)}</div>
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap">
                                                    <StatusBadge status={status} />
                                                    {status === 'retired' && retirementDate && (
                                                        <div className="text-xs text-gray-500 mt-1">
                                                            退役于 {formatDate(retirementDate)}
                                                        </div>
                                                    )}
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap">
                                                    <div className="text-sm text-gray-900">{daysUsed}</div>
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap">
                                                    <div className="text-sm text-gray-900">¥{dailyCost.toFixed(2)}</div>
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap">
                                                    <div className={`text-sm font-medium ${status === 'active' ? 'text-green-600' : 'text-gray-400'}`}>
                                                        {status === 'active' ? `¥${todayCost.toFixed(2)}` : '-'}
                                                    </div>
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap">
                                                    <button
                                                        className="view-trend-btn text-blue-600 hover:text-blue-800 mr-3 transition-all text-sm"
                                                        onClick={() => onViewTrend(product)}
                                                    >
                                                        <i className="fa fa-line-chart"></i> 查看趋势
                                                    </button>
                                                </td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>
            );
        };

        const ProductForm = ({ isOpen, onClose, onSave, product }) => {
            const [name, setName] = React.useState('');
            const [purchaseDate, setPurchaseDate] = React.useState('');
            const [purchasePrice, setPurchasePrice] = React.useState('');
            const [status, setStatus] = React.useState('active');
            const [retirementDate, setRetirementDate] = React.useState('');

            React.useEffect(() => {
                if (product) {
                    setName(product.name);
                    setPurchaseDate(product.purchaseDate);
                    setPurchasePrice(product.purchasePrice.toString());
                    setStatus(product.status || 'active');
                    setRetirementDate(product.retirementDate || '');
                } else {
                    setName('');
                    setPurchaseDate(dayjs().format('YYYY-MM-DD'));
                    setPurchasePrice('');
                    setStatus('active');
                    setRetirementDate('');
                }
            }, [product, isOpen]);

            const handleSubmit = (e) => {
                e.preventDefault();

                // 表单验证
                const errors = [];

                if (!name) errors.push('请输入产品名称');
                if (!purchaseDate) errors.push('请选择购买日期');
                if (!purchasePrice) {
                    errors.push('请输入购买价格');
                } else {
                    const price = parseFloat(purchasePrice);
                    if (isNaN(price) || price <= 0) {
                        errors.push('购买价格必须大于0');
                    }
                }

                if (status === 'retired' && !retirementDate) {
                    errors.push('请选择退役日期');
                }

                if (retirementDate && dayjs(retirementDate).isBefore(dayjs(purchaseDate))) {
                    errors.push('退役日期不能早于购买日期');
                }

                if (errors.length > 0) {
                    onClose(errors.join('\\n'), 'error');
                    return;
                }

                const price = parseFloat(purchasePrice);

                const productData = {
                    id: product ? product.id : generateId(),
                    name,
                    purchaseDate,
                    purchasePrice: price,
                    status,
                    retirementDate: status === 'retired' ? retirementDate : null
                };

                onSave(productData);
                onClose('产品已成功保存');
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-md mx-4 animate-slide-in">
                        <div className="p-6 border-b flex justify-between items-center">
                            <h3 className="text-lg font-semibold text-gray-800 flex items-center">
                                <i className="fa fa-cube mr-2 text-primary"></i>
                                {product ? '编辑产品' : '添加产品'}
                            </h3>
                            <button onClick={() => onClose()} className="text-gray-400 hover:text-gray-600 transition-all">
                                <i className="fa fa-times"></i>
                            </button>
                        </div>
                        <form onSubmit={handleSubmit} className="p-6">
                            <div className="mb-4">
                                <label htmlFor="product-name" className="block text-sm font-medium text-gray-700 mb-1">
                                    产品名称 <span className="text-red-500">*</span>
                                </label>
                                <input
                                    type="text"
                                    id="product-name"
                                    className="w-full px-3 py-2 border border-gray-300 rounded-md input-focus"
                                    placeholder="例如：iPhone 13"
                                    value={name}
                                    onChange={(e) => setName(e.target.value)}
                                    required
                                />
                            </div>
                            <div className="mb-4">
                                <label htmlFor="purchase-date" className="block text-sm font-medium text-gray-700 mb-1">
                                    购买日期 <span className="text-red-500">*</span>
                                </label>
                                <input
                                    type="date"
                                    id="purchase-date"
                                    className="w-full px-3 py-2 border border-gray-300 rounded-md input-focus"
                                    value={purchaseDate}
                                    onChange={(e) => setPurchaseDate(e.target.value)}
                                    required
                                />
                            </div>
                            <div className="mb-4">
                                <label htmlFor="purchase-price" className="block text-sm font-medium text-gray-700 mb-1">
                                    购买价格 (¥) <span className="text-red-500">*</span>
                                </label>
                                <input
                                    type="number"
                                    id="purchase-price"
                                    className="w-full px-3 py-2 border border-gray-300 rounded-md input-focus"
                                    placeholder="例如：6999"
                                    step="0.01"
                                    min="0"
                                    value={purchasePrice}
                                    onChange={(e) => setPurchasePrice(e.target.value)}
                                    required
                                />
                            </div>
                            <div className="mb-4">
                                <label htmlFor="product-status" className="block text-sm font-medium text-gray-700 mb-1">
                                    产品状态 <span className="text-red-500">*</span>
                                </label>
                                <select
                                    id="product-status"
                                    className="w-full px-3 py-2 border border-gray-300 rounded-md input-focus"
                                    value={status}
                                    onChange={(e) => setStatus(e.target.value)}
                                    required
                                >
                                    <option value="active">服役中</option>
                                    <option value="retired">已退役</option>
                                </select>
                            </div>
                            {status === 'retired' && (
                                <div className="mb-6">
                                    <label htmlFor="retirement-date" className="block text-sm font-medium text-gray-700 mb-1">
                                        退役日期 <span className="text-red-500">*</span>
                                    </label>
                                    <input
                                        type="date"
                                        id="retirement-date"
                                        className="w-full px-3 py-2 border border-gray-300 rounded-md input-focus"
                                        value={retirementDate}
                                        onChange={(e) => setRetirementDate(e.target.value)}
                                        min={purchaseDate}
                                        required
                                    />
                                </div>
                            )}
                            <div className="flex justify-end space-x-3">
                                <button
                                    type="button"
                                    onClick={() => onClose()}
                                    className="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition-all"
                                >
                                    取消
                                </button>
                                <button
                                    type="submit"
                                    className="px-4 py-2 bg-primary text-white rounded-md hover:bg-blue-600 transition-all shadow-md hover:shadow-lg"
                                >
                                    <i className="fa fa-save mr-1"></i> 保存
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        const DeleteConfirmation = ({ isOpen, onClose, onConfirm, product }) => {
            if (!isOpen || !product) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-sm mx-4 animate-slide-in">
                        <div className="p-6 border-b flex justify-between items-center">
                            <h3 className="text-lg font-semibold text-gray-800 flex items-center">
                                <i className="fa fa-exclamation-triangle mr-2 text-red-500"></i>
                                确认删除
                            </h3>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600 transition-all">
                                <i className="fa fa-times"></i>
                            </button>
                        </div>
                        <div className="p-6">
                            <div className="flex items-center justify-center mb-4">
                                <div className="w-16 h-16 rounded-full bg-red-100 flex items-center justify-center">
                                    <i className="fa fa-trash text-red-500 text-2xl"></i>
                                </div>
                            </div>
                            <p className="text-gray-700 mb-6 text-center">
                                您确定要删除 <span className="font-medium">{product.name}</span> 吗？<br />
                                此操作无法撤销。
                            </p>
                            <div className="flex justify-end space-x-3">
                                <button
                                    onClick={onClose}
                                    className="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition-all"
                                >
                                    取消
                                </button>
                                <button
                                    onClick={onConfirm}
                                    className="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-all"
                                >
                                    <i className="fa fa-trash mr-1"></i> 删除
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            // 从内联脚本标签获取产品数据
            const getInitialProducts = () => {
                try {
                    const dataScript = document.getElementById('products-data');
                    if (dataScript) {
                        return JSON.parse(dataScript.textContent);
                    }
                    return [];
                } catch (error) {
                    console.error('Error parsing initial products data:', error);
                    return [];
                }
            };

            const [products, setProducts] = React.useState(getInitialProducts());
            const [isFormOpen, setIsFormOpen] = React.useState(false);
            const [isDeleteOpen, setIsDeleteOpen] = React.useState(false);
            const [isTrendOpen, setIsTrendOpen] = React.useState(false);
            const [currentProduct, setCurrentProduct] = React.useState(null);
            const [deleteProduct, setDeleteProduct] = React.useState(null);
            const [trendProduct, setTrendProduct] = React.useState(null);
            const [chartDays, setChartDays] = React.useState(7);
            const [notification, setNotification] = React.useState({
                isOpen: false,
                message: '',
                type: 'success'
            });

            // 设置时间筛选按钮事件
            React.useEffect(() => {
                const timeFilterBtns = document.querySelectorAll('.time-filter-btn');
                timeFilterBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        // 更新按钮样式
                        timeFilterBtns.forEach(b => {
                            b.classList.remove('bg-primary', 'text-white');
                            b.classList.add('bg-gray-200', 'text-gray-700');
                        });
                        btn.classList.remove('bg-gray-200', 'text-gray-700');
                        btn.classList.add('bg-primary', 'text-white');

                        // 更新图表
                        const days = parseInt(btn.dataset.days);
                        setChartDays(days);
                    });
                });
            }, []);

            // 显示通知
            const showNotification = (message, type = 'success', duration = 3000) => {
                setNotification({
                    isOpen: true,
                    message,
                    type
                });

                // 自动关闭通知
                setTimeout(() => {
                    setNotification({
                        ...notification,
                        isOpen: false
                    });
                }, duration);
            };

            // 保存产品数据
            const saveProducts = (updatedProducts) => {
                try {
                    // 更新状态
                    setProducts(updatedProducts);

                    // 提供下载更新后的JSON文件
                    const blob = new Blob([JSON.stringify(updatedProducts, null, 2)], {type: 'application/json'});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'products.json';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                    showNotification('产品数据已更新，请保存下载的 products.json 文件');
                } catch (error) {
                    console.error('Error saving products:', error);
                    showNotification('保存产品数据失败: ' + error.message, 'error');
                }
            };

            // 添加或编辑产品
            const handleSaveProduct = (productData) => {
                const isEdit = !!currentProduct;
                let updatedProducts;

                if (isEdit) {
                    updatedProducts = products.map(p =>
                        p.id === productData.id ? productData : p
                    );
                } else {
                    updatedProducts = [...products, productData];
                }

                saveProducts(updatedProducts);
                setIsFormOpen(false);
                setCurrentProduct(null);
            };

            // 删除产品
            const handleDeleteProduct = () => {
                if (!deleteProduct) return;

                const updatedProducts = products.filter(p => p.id !== deleteProduct.id);
                saveProducts(updatedProducts);
                setIsDeleteOpen(false);
                setDeleteProduct(null);
                showNotification('产品已成功删除');
            };

            // 打开添加产品表单
            const handleAddProduct = () => {
                setCurrentProduct(null);
                setIsFormOpen(true);
            };

            // 打开编辑产品表单
            const handleEditProduct = (product) => {
                setCurrentProduct(product);
                setIsFormOpen(true);
            };

            // 打开删除确认对话框
            const handleDeleteClick = (product) => {
                setDeleteProduct(product);
                setIsDeleteOpen(true);
            };

            // 打开产品趋势对话框
            const handleViewTrend = (product) => {
                setTrendProduct(product);
                setIsTrendOpen(true);
            };

            // 关闭产品表单对话框
            const handleFormClose = (message, type = 'success') => {
                setIsFormOpen(false);
                setCurrentProduct(null);

                if (message) {
                    showNotification(message, type);
                }
            };

            return (
                <div className="min-h-screen bg-gray-50">
                    <Header />
                    <main className="container mx-auto px-4 py-6">
                        <Summary products={products} />
                        <CostTrendChart days={chartDays} products={products} />
                        <ProductList products={products} onViewTrend={handleViewTrend}/>
                    </main>
                    <ProductForm
                        isOpen={isFormOpen}
                        onClose={handleFormClose}
                        onSave={handleSaveProduct}
                        product={currentProduct}
                    />
                    <DeleteConfirmation
                        isOpen={isDeleteOpen}
                        onClose={() => setIsDeleteOpen(false)}
                        onConfirm={handleDeleteProduct}
                        product={deleteProduct}
                    />
                    <ProductTrendModal
                        isOpen={isTrendOpen}
                        onClose={() => setIsTrendOpen(false)}
                        product={trendProduct}
                    />
                    <Notification
                        isOpen={notification.isOpen}
                        message={notification.message}
                        type={notification.type}
                    />
                </div>
            );
        };

        // 渲染应用
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
