<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>电子产品成本计算器</title>
    <!-- Tailwind CSS v3 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <!-- Day.js -->
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <!-- React -->
    <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.development.js"></script>
    <!-- React DOM -->
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.development.js"></script>
    <!-- Babel (用于JSX转换) -->
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.23.4/babel.min.js"></script>
      <!-- 统一的 Tailwind 配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6', // 科技蓝
                        secondary: '#6B7280', // 中性灰
                        accent: '#F97316', // 橙色强调色
                        light: '#F3F4F6',
                        dark: '#1F2937',
                        success: '#10B981', // 成功绿
                        danger: '#EF4444', // 危险红
                        warning: '#F59E0B', // 警告黄
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-in-out',
                        'slide-in': 'slideIn 0.5s ease-in-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                        'slide-down': 'slideDown 0.3s ease-in',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideIn: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(100%)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        slideDown: {
                            '0%': { transform: 'translateY(0)', opacity: '1' },
                            '100%': { transform: 'translateY(100%)', opacity: '0' },
                        }
                    }
                }
            }
        }
    </script>
    <!-- 产品数据 -->
    <script src="./products.js"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="root"></div>

    <script type="text/babel" data-presets="react">
        // 根据已使用天数计算日均成本，考虑产品状态
        const ProductStatus = Object.freeze({ ACTIVE: 'active', RETIRED: 'retired' });
        const calculateDailyCost = (product, currentDate = dayjs().format('YYYY-MM-DD')) => {
            // 如果产品已退役，使用退役日期作为计算终点
            const endDate = product.status === ProductStatus.RETIRED && product.retirementDate ?
                            product.retirementDate : currentDate;

            // 计算已使用天数
            const daysUsed = calculateDaysBetween(product.purchaseDate, endDate);

            // 如果使用天数为0，返回0（避免除以零）
            return daysUsed > 0 ? product.purchasePrice / daysUsed : 0;
        };

        const calculateDaysBetween = (startDate, endDate) => {
            return Math.abs(dayjs(endDate).diff(dayjs(startDate), 'day'));
        };

        const formatDate = (dateStr, format = 'full') => {
            const d = dayjs(dateStr);
            return format === 'short' ? d.format('MM-DD') : d.format('YYYY-MM-DD');
        };

        const currencyFormatter = new Intl.NumberFormat('zh-CN', { style: 'currency', currency: 'CNY', maximumFractionDigits: 2 });

        const formatCurrency = (value) => {
            const num = Number(value) || 0;
            return currencyFormatter.format(num);
        };

        const generateId = () => {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        };

        // 生成单个产品的趋势数据
        const generateProductTrendData = (product) => {
            const labels = [];
            const costData = [];
            const start = dayjs(product.purchaseDate);
            const end = product.status === ProductStatus.RETIRED && product.retirementDate ? dayjs(product.retirementDate) : dayjs();
            const maxDays = 180;
            let daysGenerated = 0;
            let d = start;
            while (d.isBefore(end.add(1, 'day')) && daysGenerated < maxDays) {
                const dateStr = d.format('YYYY-MM-DD');
                labels.push(d.format('MM-DD'));
                const daysUsed = calculateDaysBetween(product.purchaseDate, dateStr);
                const dailyCost = daysUsed > 0 ? product.purchasePrice / daysUsed : 0;
                costData.push(dailyCost);
                d = d.add(1, 'day');
                daysGenerated++;
            }
            return { labels, costData };
        };

        // 组件
        const Header = () => {
            return (
                <header className="bg-white shadow-sm">
                    <div className="container mx-auto px-4 py-4 flex justify-between items-center">
                        <div className="flex items-center space-x-2">
                            <i className="fa fa-calculator text-primary text-2xl"></i>
                            <h1 className="text-xl font-semibold text-gray-800">电子产品成本计算器</h1>
                        </div>
                    </div>
                </header>
            );
        };

        // 通知提示组件
        const Notification = ({ isOpen, message, type = 'success' }) => {
            if (!isOpen) return null;

            const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';

            return (
                <div className={`fixed top-4 right-4 ${bgColor} text-white px-4 py-2 rounded-md shadow-lg animate-fade-in z-50 flex items-center`}>
                    <i className={`fa ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} mr-2`}></i>
                    {message}
                </div>
            );
        };

        const Summary = ({ products }) => {
            const totalProducts = products.length;

            // 计算今日总成本（只包括服役中产品）
            const todayTotalCost = products.reduce((sum, product) => {
                if (product.status === ProductStatus.ACTIVE) {
                    const dailyCost = calculateDailyCost(product);
                    return sum + dailyCost;
                }
                return sum;
            }, 0);

            // 计算总投资金额
            const totalInvestment = products.reduce((sum, product) => {
                return sum + product.purchasePrice;
            }, 0);

            return (
                <section className="mb-8 animate-fade-in">
                    <div className="bg-white rounded-lg shadow-sm p-6 border-l-4 border-primary">
                        <h2 className="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                            <i className="fa fa-calendar-check-o mr-2 text-primary"></i>今日汇总
                        </h2>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div className="bg-blue-50 p-4 rounded-md transform transition-all hover:scale-105">
                                <p className="text-sm text-gray-500">总产品数</p>
                                <p className="text-2xl font-bold text-primary">{totalProducts}</p>
                            </div>
                            <div className="bg-green-50 p-4 rounded-md transform transition-all hover:scale-105">
                                <p className="text-sm text-gray-500">今日总成本</p>
                                <p className="text-2xl font-bold text-green-600">{formatCurrency(todayTotalCost)}</p>
                            </div>
                            <div className="bg-purple-50 p-4 rounded-md transform transition-all hover:scale-105">
                                <p className="text-sm text-gray-500">总投资金额</p>
                                <p className="text-2xl font-bold text-purple-600">{formatCurrency(totalInvestment)}</p>
                            </div>
                        </div>
                    </div>
                </section>
            );
        };

        const CostTrendChart = ({ days, products, onChangeDays }) => {
            const chartRef = React.useRef(null);
            const canvasRef = React.useRef(null);
            const generateChartData = (days, products) => {
                const labels = [];
                const totalCostData = [];
                const productCosts = {};

                // 初始化产品成本数据
                products.forEach(product => {
                    productCosts[product.id] = {
                        name: product.name,
                        data: []
                    };
                });

                // 生成过去N天的数据
                for (let i = days - 1; i >= 0; i--) {
                    const d = dayjs().subtract(i, 'day');
                    const dateStr = d.format('YYYY-MM-DD');
                    labels.push(d.format('MM-DD'));
                    let dailyTotal = 0;
                    products.forEach(product => {
                        if (dateStr >= product.purchaseDate && product.status === ProductStatus.ACTIVE) {
                            const dailyCost = calculateDailyCost(product, dateStr);
                            dailyTotal += dailyCost;
                            productCosts[product.id].data.push(dailyCost);
                        } else {
                            productCosts[product.id].data.push(0);
                        }
                    });
                    totalCostData.push(dailyTotal);
                }

                // 准备数据集
                const datasets = [
                    {
                        label: '总成本',
                        data: totalCostData,
                        borderColor: '#3B82F6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        borderWidth: 2,
                        pointBackgroundColor: '#3B82F6',
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }
                ];

                // 为每个产品添加数据集（最多显示5个产品，避免图表过于复杂）
                const productIds = Object.keys(productCosts).slice(0, 5);
                const colors = ['#F97316', '#10B981', '#8B5CF6', '#EC4899', '#EF4444'];

                productIds.forEach((productId, index) => {
                    const product = productCosts[productId];
                    datasets.push({
                        label: product.name,
                        data: product.data,
                        borderColor: colors[index % colors.length],
                        borderWidth: 2,
                        borderDash: [5, 5],
                        pointBackgroundColor: colors[index % colors.length],
                        pointRadius: 3,
                        pointHoverRadius: 5,
                        fill: false
                    });
                });

                return { labels, datasets };
            };



            const { labels, datasets } = React.useMemo(() => generateChartData(days, products), [days, products]);

            React.useEffect(() => {
                // 如果图表已存在，销毁它
                if (chartRef.current) {
                    chartRef.current.destroy();
                }

                // 创建图表
                const ctx = canvasRef.current.getContext('2d');
                chartRef.current = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            label += formatCurrency(context.parsed.y);
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    display: false
                                }
                            },
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return formatCurrency(value);
                                    }
                                }
                            }
                        },
                        interaction: {
                            mode: 'nearest',
                            axis: 'x',
                            intersect: false
                        },
                        elements: {
                            line: {
                                tension: 0.3
                            }
                        }
                    }
                });

                return () => {
                    if (chartRef.current) {
                        chartRef.current.destroy();
                    }
                };
            }, [labels, datasets]);


            return (
                <section className="mb-8 animate-fade-in" style={{ animationDelay: '0.1s' }}>
                    <div className="bg-white rounded-lg shadow-sm p-6">
                        <h2 className="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                            <i className="fa fa-line-chart mr-2 text-primary"></i>成本趋势
                        </h2>
                        <div className="mb-4 flex flex-wrap gap-2">
                            <button
                                className={`time-filter-btn px-3 py-1 rounded-md text-sm ${days === 7 ? 'bg-primary text-white' : 'bg-gray-200 text-gray-700'}`}
                                onClick={() => onChangeDays(7)}
                            >
                                最近7天
                            </button>
                            <button
                                className={`time-filter-btn px-3 py-1 rounded-md text-sm ${days === 30 ? 'bg-primary text-white' : 'bg-gray-200 text-gray-700'}`}
                                onClick={() => onChangeDays(30)}
                            >
                                最近30天
                            </button>
                            <button
                                className={`time-filter-btn px-3 py-1 rounded-md text-sm ${days === 90 ? 'bg-primary text-white' : 'bg-gray-200 text-gray-700'}`}
                                onClick={() => onChangeDays(90)}
                            >
                                最近90天
                            </button>
                        </div>
                        <div className="h-64">
                            <canvas ref={canvasRef}></canvas>
                        </div>
                    </div>
                </section>
            );
        };

        // 状态标签组件
        const StatusBadge = ({ status }) => {
            if (status === ProductStatus.ACTIVE) {
                return (
                    <span className="px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded-full flex items-center">
                        <span className="w-2 h-2 bg-green-500 rounded-full mr-1"></span>
                        服役中
                    </span>
                );
            } else if (status === ProductStatus.RETIRED) {
                return (
                    <span className="px-2 py-1 text-xs font-medium bg-gray-100 text-gray-800 rounded-full flex items-center">
                        <span className="w-2 h-2 bg-gray-500 rounded-full mr-1"></span>
                        已退役
                    </span>
                );
            }
            return null;
        };

        // 产品趋势模态框
            const ProductTrendModal = ({ isOpen, onClose, product }) => {
            const chartRef = React.useRef(null);
            const canvasRef = React.useRef(null);

            React.useEffect(() => {
                if (isOpen && product) {
                    renderChart();
                }

                return () => {
                    if (chartRef.current) {
                        chartRef.current.destroy();
                    }
                };
            }, [isOpen, product]);

            const renderChart = () => {
                const { labels, costData } = generateProductTrendData(product);

                if (chartRef.current) {
                    chartRef.current.destroy();
                }

                const ctx = canvasRef.current.getContext('2d');
                chartRef.current = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: `${product.name} 日均成本`,
                            data: costData,
                            borderColor: '#3B82F6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            fill: true,
                            borderWidth: 2,
                            pointBackgroundColor: '#3B82F6',
                            pointRadius: 3,
                            pointHoverRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            label += formatCurrency(context.parsed.y);
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    display: false
                                }
                            },
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return formatCurrency(value);
                                    }
                                }
                            }
                        },
                        interaction: {
                            mode: 'nearest',
                            axis: 'x',
                            intersect: false
                        },
                        elements: {
                            line: {
                                tension: 0.3
                            }
                        }
                    }
                });
            };

            if (!isOpen || !product) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-4xl mx-4 animate-slide-in">
                        <div className="p-6 border-b flex justify-between items-center">
                            <h3 className="text-lg font-semibold text-gray-800 flex items-center">
                                <i className="fa fa-line-chart mr-2 text-primary"></i>
                                {product.name} 成本趋势
                            </h3>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600 transition-all">
                                <i className="fa fa-times"></i>
                            </button>
                        </div>
                        <div className="p-6">
                            <div className="mb-4 bg-gray-50 p-4 rounded-md">
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <p className="text-sm text-gray-500">购买日期</p>
                                        <p className="font-medium">{formatDate(product.purchaseDate)}</p>
                                    </div>
                                    <div>
                                        <p className="text-sm text-gray-500">购买价格</p>
                                        <p className="font-medium">{formatCurrency(product.purchasePrice)}</p>
                                    </div>
                                    <div>
                                        <p className="text-sm text-gray-500">状态</p>
                                        <div className="flex items-center mt-1">
                                            <StatusBadge status={product.status} />
                                            {product.status === ProductStatus.RETIRED && product.retirementDate && (
                                                <span className="text-sm text-gray-500 ml-2">
                                                    (退役于 {formatDate(product.retirementDate)})
                                                </span>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div className="h-80">
                                <canvas ref={canvasRef}></canvas>
                            </div>
                            <div className="mt-4 text-center text-sm text-gray-500">
                                显示从购买日期到{product.status === ProductStatus.RETIRED ? '退役日期' : '今天'}的成本趋势（最多显示180天）
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const ProductList = ({ products, onViewTrend }) => {
            if (products.length === 0) {
                return (
                    <section className="animate-fade-in" style={{ animationDelay: '0.2s' }}>
                        <div className="bg-white rounded-lg shadow-sm overflow-hidden">
                            <div className="p-6 border-b">
                                <h2 className="text-lg font-semibold text-gray-800 flex items-center">
                                    <i className="fa fa-list-ul mr-2 text-primary"></i>产品列表
                                </h2>
                            </div>
                            <div className="p-10 text-center">
                                <div className="flex flex-col items-center">
                                    <div className="w-16 h-16 rounded-full bg-blue-100 flex items-center justify-center mb-4">
                                        <i className="fa fa-info-circle text-primary text-2xl"></i>
                                    </div>
                                    <p className="text-gray-500">暂无产品数据，请添加产品</p>
                                </div>
                            </div>
                        </div>
                    </section>
                );
            }

            return (
                <section className="animate-fade-in" style={{ animationDelay: '0.2s' }}>
                    <div className="bg-white rounded-lg shadow-sm overflow-hidden">
                        <div className="p-6 border-b flex justify-between items-center">
                            <h2 className="text-lg font-semibold text-gray-800 flex items-center">
                                <i className="fa fa-list-ul mr-2 text-primary"></i>产品列表
                            </h2>
                            <div className="text-sm text-gray-500">
                                共 {products.length} 个产品
                            </div>
                        </div>
                        <div className="overflow-x-auto">
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            产品名称
                                        </th>
                                        <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            购买日期
                                        </th>
                                        <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            购买价格
                                        </th>
                                        <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            状态
                                        </th>
                                        <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            已使用天数
                                        </th>
                                        <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            日均成本
                                        </th>
                                         <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            今日成本
                                        </th>
                                        <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            操作
                                        </th>
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                    {products.map(product => {
                                        console.log('xxx-2', product, product.id)
                                        const {
                                            id,
                                            name,
                                            purchaseDate,
                                            purchasePrice,
                                            status,
                                            retirementDate
                                        } = product;



                                        // 计算已使用天数
                                        const endDate = status === ProductStatus.RETIRED && retirementDate ?
                                                        retirementDate : dayjs().format('YYYY-MM-DD');
                                        const daysUsed = calculateDaysBetween(purchaseDate, endDate);

                                        // 计算日均成本
                                        const dailyCost = calculateDailyCost(product);

                                        // 计算今日成本（只对服役中产品计算）
                                        const todayCost = status === ProductStatus.ACTIVE ? dailyCost : 0;

                                        return (
                                            <tr key={id} className="hover:bg-gray-50 transition-all">
                                                <td className="px-6 py-4 whitespace-nowrap">
                                                    <div className="flex items-center">
                                                        <div className="ml-4">
                                                            <div className="text-sm font-medium text-gray-900">{name}</div>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap">
                                                    <div className="text-sm text-gray-900">{formatDate(purchaseDate)}</div>
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap">
                                                    <div className="text-sm text-gray-900">{formatCurrency(purchasePrice)}</div>
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap">
                                                    <StatusBadge status={status} />
                                                    {status === ProductStatus.RETIRED && retirementDate && (
                                                        <div className="text-xs text-gray-500 mt-1">
                                                            退役于 {formatDate(retirementDate)}
                                                        </div>
                                                    )}
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap">
                                                    <div className="text-sm text-gray-900">{daysUsed}</div>
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap">
                                                    <div className="text-sm text-gray-900">{formatCurrency(dailyCost)}</div>
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap">
                                                    <div className={`text-sm font-medium ${status === 'active' ? 'text-green-600' : 'text-gray-400'}`}>
                                                        {status === 'active' ? formatCurrency(todayCost) : '-'}
                                                    </div>
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap">
                                                    <button
                                                        className="view-trend-btn text-blue-600 hover:text-blue-800 mr-3 transition-all text-sm"
                                                        onClick={() => onViewTrend(product)}
                                                    >
                                                        <i className="fa fa-line-chart"></i> 查看趋势
                                                    </button>
                                                </td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>
            );
        };

        const App = () => {
            const products = product_list; // 从products.js中获取
            const [isTrendOpen, setIsTrendOpen] = React.useState(false);
            const [trendProduct, setTrendProduct] = React.useState(null);
            const [chartDays, setChartDays] = React.useState(7);

            // 打开产品趋势对话框
            const handleViewTrend = (product) => {
                setTrendProduct(product);
                setIsTrendOpen(true);
            };

            return (
                <div className="min-h-screen bg-gray-50">
                    <Header />
                    <main className="container mx-auto px-4 py-6">
                        <Summary products={products} />
                        <CostTrendChart days={chartDays} products={products} onChangeDays={setChartDays} />
                        <ProductList products={products} onViewTrend={handleViewTrend}/>
                    </main>
                    <ProductTrendModal isOpen={isTrendOpen} onClose={() => setIsTrendOpen(false)} product={trendProduct}/>
                </div>
            );
        };

        // 渲染应用
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
